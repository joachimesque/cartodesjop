<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte Leaflet avec GeoJSON</title>
  <link href="./css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="./css/leaflet.css" />
  <style>
    #map {
      height: 500px;
    }
    #result {
      margin-top: 10px;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-md bg-dark sticky-top border-bottom" data-bs-theme="dark">
  <div class="container">
      <div class="offcanvas-body">
        <ul class="navbar-nav flex-grow-1 center">
          <li class="nav-item"><a class="nav-link" href="https://technopolice.fr/">
                TECHNOPOLICE
              </a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<main>
<section class="py-5 text-center container">
  <div class="row py-lg-5">
    <div class="col-lg-6 col-md-8 mx-auto">
      <h1 class="fw-light">Ce qui nous attend pour les JO</h1>
      <p class="lead text-body-secondary">Indiquer une adresse pour savoir à quoi vous préparer pour les JO</p>
      <form id="addressForm">
        <input id="adresseInput" type="text" list="suggestionsList" placeholder="Votre adresse" class="form-control">
        <datalist id="suggestionsList"></datalist>
        <button type="submit" class="btn btn-primary my-2">Voir</button>
      </form>
    </div>
  </div>
</section>

<div class="row row-cols-1 row-cols-sm-1 row-cols-md-2 g-3">
  <div class="col">
    <div class="card shadow-sm">
        <div id="map"></div>
    </div>
  </div>

  <div class="col">
    <div class="card shadow-sm">
        <div id="result" class="p-3">
                <h2 id="titre">Vue globale</h2>
                <div id="zone_silt">
                <p><span style="background-color: black;"> &nbsp; &nbsp; &nbsp; </span> &nbsp; <strong>Zone Anti-terroriste</strong> : Accès totalement interdit aux véhicules mototisés et aux piétons non autorisés. Des « visites » administratives de tout lieu de la zone sont prévues par la loi SILT pour notamment saisir de données informatique (le conseil consitutionnel n'a pas autorisé la saisie de documents et d'objets).</p>
                <p id="zone_silt_comment">10,00 % de Paris intramuros est concerné par cette zone à un moment des Jeux olympiques et paralympiques.</p>
                </div>
                <div id="zone_rouge">
                <p><span style="background-color: red;"> &nbsp; &nbsp; &nbsp; </span> &nbsp; <strong>Zone de circulation interdite</strong> : Accès interdit aux véhicules mototisés. Un portail web permettra de déposer une demande de dérogation (et des pièces justificatices). Si le motif est jugé légitime par la préfecture de police, un QRCode se délivré. Il permettra l'entrée du véhicule dans la zone. Ce QRCode ne permettra pas aux véhicules de passer pendant les durée des épreuves qui se dérouleront sur route.</li>
                <p id="zone_rouge_comment">58,62 % de Paris intramuros est concerné par cette zone à un moment des Jeux olympiques et paralympiques.</p>
                </div>
                <div id="zone_bleu">
                <p><span style="background-color: orange;"> &nbsp; &nbsp; &nbsp; </span> &nbsp; <strong>Zone de circulation réglementée</strong> : Le conducteur du véhicules doit être muni d'un QRCode d'accès à la zone rouge ou justifier auprès des forces de l'ordre en charge du barrage de justifier de son besoin d’accès à la zone (accès au domicile, travail, livraison, dépannage, déménagement, rendez-vous médical, ...).</p>
                <p id="zone_bleu_comment">65,00 % de Paris intramuros est concerné par cette zone à un moment des Jeux olympiques et paralympiques.</p>
                </div>
        </div>
    </div>
  </div>

</div>

  <!-- Ajouter des contrôles pour les couches GeoJSON -->
  <div id="layerControls"></div>

  <script src="./js/leaflet.js"></script>
  <script src="./js/turf.min.js"></script>
  <script>
    var map = L.map('map').setView([48.8566, 2.3522], 12);

    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var geojsonLayers = {};
    var geojsonPaths_rouge = [
        "geojson/20240715-20240910_perimetre_CIRCULATION-DISPOSITIF-VILLAGE-OLYMPIQUE-SP_rouge.geojson",
        "geojson/20240719-20240725_pdf_cer1-j8j1-4ep-LOYL_rouge.geojson",
        "geojson/20240719-20240725_perimetre_CER1-JoursAvants_rouge.geojson",
        "geojson/20240724-20240727_perimetre_cyclisme-clm-fam_rouge.geojson",
        "geojson/20240724-20240727_perimetre_cyclisme-clm_rouge.geojson",
        "geojson/20240724-20240810_perimetre_CIRCULATION-DISPOSITIF-PARC-DES-PRINCES-SP_rouge.geojson",
        "geojson/20240724-20240909_perimetre_CIRCULATION-DISPOSITIF-STADE-DE-FRANCE-SP_rouge.geojson",
        "geojson/20240725-20240905_perimetre_CIRCULATION-DISPOSITIF-INVALIDES-SP_rouge.geojson",
        "geojson/20240725-20240907_perimetre_CIRCULATION-DISPOSITIF-ARENA-PARIS-SUD-SP_rouge.geojson",
        "geojson/20240726-20240726_pdf_cer1-jj-4ep-Wye8_rouge.geojson",
        "geojson/20240726-20240726_perimetre_CER1-JourJ_rouge.geojson",
        "geojson/20240726-20240811_perimetre_CIRCULATION-DISPOSITIF-TROCADERO-SP_rouge.geojson",
        "geojson/20240727-20240809_perimetre_CIRCULATION-DISPOSITIF-STADE-YVES-DU-MANOIR-SP_rouge.geojson",
        "geojson/20240727-20240810_perimetre_CIRCULATION-DISPOSITIF-CENTRE-AQUATIQUE-SP_rouge.geojson",
        "geojson/20240727-20240905_perimetre_CIRCULATION-DISPOSITIF-ARENA-PORTE-DE-LA-CHAPELLE-SP_rouge.geojson",
        "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-ARENA-PARIS-NORD-SP_rouge.geojson",
        "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-CHATEAU-DE-VERSAILLES-SP_rouge.geojson",
        "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-EIFFEL-CHAMP-DE-MARS-SP_rouge.geojson",
        "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-PARIS-LA-DEFENSE-ARENA-SP_rouge.geojson",
        "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-STADE-ROLAND-GARROS-SP_rouge.geojson",
        "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-ARENA-BERCY-SP_rouge.geojson",
        "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-GRAND-PALAIS-SP_rouge.geojson",
        "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-LA-CONCORDE-SP_rouge.geojson",
        "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-LCO-GRX-SP_rouge.geojson",
        "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-STADE-NAUTIQUE-DE-VAIRES-SUR-MARNE-SP_rouge.geojson",
        "geojson/20240728-20240729_perimetre_CIRCULATION-DISPOSITIF-COLLINE-D-ELANCOURT-SP_rouge.geojson",
        "geojson/20240728-20240805_perimetre_triathlon-fam-Cyc-Nat_rouge.geojson",
        "geojson/20240728-20240805_perimetre_triathlon-indiv-femme_rouge.geojson",
        "geojson/20240728-20240805_perimetre_triathlon-indiv-homme_rouge.geojson",
        "geojson/20240728-20240805_perimetre_triathlon-relaix-mixte_rouge.geojson",
        "geojson/20240801-20240810_perimetre_CIRCULATION-DISPOSITIF-LE-GOLF-NATIONAL-SP_rouge.geojson",
        "geojson/20240801-20240901_perimetre_CIRCULATION-DISPOSITIF-VELODROME-NATIONAL-DE-SAINT-QUENTIN-EN-YVELINES-SP_rouge.geojson",
        "geojson/20240803-20240804_perimetre_course-en-ligne-homme_rouge.geojson",
        "geojson/20240803-20240804_perimetre_cyclisme-courseenligne-femme_rouge.geojson",
        "geojson/20240805-20240810_perimetre_CIRCULATION-DISPOSITIF-SITE-D-ESCALADE-DU-BOURGET-SP_rouge.geojson",
        "geojson/20240810-20240811_perimetre_marathon-femme_rouge.geojson",
        "geojson/20240810-20240811_perimetre_marathon-homme_rouge.geojson",
        "geojson/20240810-20240811_perimetre_marathon-pour-tous_rouge.geojson",
        "geojson/20240828-20240828_perimetre_CER3-Ceremonie-d-ouverture-Jeux-Paralympiques_rouge.geojson",
        "geojson/20240903-20240908_perimetre_PARA-Cyclisme-fam_rouge.geojson",
        "geojson/20240903-20240908_perimetre_PARA-MassEvent_rouge.geojson",
        "geojson/20240904-20240907_perimetre_PARA-Cyclisme-Contre-la-Montre_rouge.geojson",
        "geojson/20240904-20240907_perimetre_PARA-Cyclisme-Course-sur-route-J1_rouge.geojson",
        "geojson/20240904-20240907_perimetre_PARA-Cyclisme-Course-sur-route-J2_rouge.geojson",
        "geojson/20240904-20240907_perimetre_PARA-Cyclisme-Course-sur-route-J3_rouge.geojson",
        "geojson/20240908-20240908_perimetre_PARA-Marathon_rouge.geojson",
        "geojson/20240908-20240909_perimetre_CER4-Ceremonie-de-cloture-des-jeux-paralympiques_rouge.geojson",
    ];

geojsonPaths_bleu = [
    "geojson/20240715-20240910_perimetre_CIRCULATION-DISPOSITIF-CENTRE-AQUATIQUE-SP_bleu.geojson",
    "geojson/20240715-20240910_perimetre_CIRCULATION-DISPOSITIF-VILLAGE-OLYMPIQUE-SP_bleu.geojson",
    "geojson/20240719-20240725_pdf_cer1-j8j1-4ep-LOYL_bleu.geojson",
    "geojson/20240719-20240725_perimetre_CER1-JoursAvants_bleu.geojson",
    "geojson/20240724-20240727_perimetre_cyclisme-clm_bleu.geojson",
    "geojson/20240724-20240727_perimetre_cyclisme-clm-fam_bleu.geojson",
    "geojson/20240724-20240810_perimetre_CIRCULATION-DISPOSITIF-PARC-DES-PRINCES-SP_bleu.geojson",
    "geojson/20240724-20240909_perimetre_CIRCULATION-DISPOSITIF-STADE-DE-FRANCE-SP_bleu.geojson",
    "geojson/20240725-20240905_perimetre_CIRCULATION-DISPOSITIF-INVALIDES-SP_bleu.geojson",
    "geojson/20240725-20240907_perimetre_CIRCULATION-DISPOSITIF-ARENA-PARIS-SUD-SP_bleu.geojson",
    "geojson/20240726-20240811_perimetre_CIRCULATION-DISPOSITIF-TROCADERO-SP_bleu.geojson",
    "geojson/20240727-20240809_perimetre_CIRCULATION-DISPOSITIF-STADE-YVES-DU-MANOIR-SP_bleu.geojson",
    "geojson/20240727-20240810_perimetre_CIRCULATION-DISPOSITIF-CENTRE-AQUATIQUE-SP_bleu.geojson",
    "geojson/20240727-20240905_perimetre_CIRCULATION-DISPOSITIF-ARENA-PORTE-DE-LA-CHAPELLE-SP_bleu.geojson",
    "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-ARENA-PARIS-NORD-SP_bleu.geojson",
    "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-CHATEAU-DE-VERSAILLES-SP_bleu.geojson",
    "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-EIFFEL-CHAMP-DE-MARS-SP_bleu.geojson",
    "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-PARIS-LA-DEFENSE-ARENA-SP_bleu.geojson",
    "geojson/20240727-20240907_perimetre_CIRCULATION-DISPOSITIF-STADE-ROLAND-GARROS-SP_bleu.geojson",
    "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-ARENA-BERCY-SP_bleu.geojson",
    "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-GRAND-PALAIS-SP_bleu.geojson",
    "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-LA-CONCORDE-SP_bleu.geojson",
    "geojson/20240727-20240908_perimetre_CIRCULATION-DISPOSITIF-LCO-GRX-SP_bleu.geojson",
    "geojson/20240728-20240729_perimetre_CIRCULATION-DISPOSITIF-COLLINE-D-ELANCOURT-SP_bleu.geojson",
    "geojson/20240728-20240805_perimetre_triathlon-fam-Cyc-Nat_bleu.geojson",
    "geojson/20240728-20240805_perimetre_triathlon-indiv-femme_bleu.geojson",
    "geojson/20240728-20240805_perimetre_triathlon-indiv-homme_bleu.geojson",
    "geojson/20240728-20240805_perimetre_triathlon-relaix-mixte_bleu.geojson",
    "geojson/20240801-20240810_perimetre_CIRCULATION-DISPOSITIF-LE-GOLF-NATIONAL-SP_bleu.geojson",
    "geojson/20240801-20240901_perimetre_CIRCULATION-DISPOSITIF-VELODROME-NATIONAL-DE-SAINT-QUENTIN-EN-YVELINES-SP_bleu.geojson",
    "geojson/20240803-20240804_perimetre_course-en-ligne-homme_bleu.geojson",
    "geojson/20240803-20240804_perimetre_cyclisme-courseenligne-femme_bleu.geojson",
    "geojson/20240810-20240811_perimetre_marathon-femme_bleu.geojson",
    "geojson/20240810-20240811_perimetre_marathon-homme_bleu.geojson",
    "geojson/20240810-20240811_perimetre_marathon-pour-tous_bleu.geojson",
];


geojsonPaths_silt = [
    "geojson/20240724-20240811_presentation_sites-olympiques-vue-92-4ep-ejtY-colombes_silt.geojson",
    "geojson/20240724-20240811_presentation_sites-olympiques-vue-92-4ep-ejtY-defense_silt.geojson",
    "geojson/20240724-20240811_presentation_sites-olympiques-vue-93-4ep-am7z-circuit_silt.geojson",
    "geojson/20240724-20240811_presentation_sites-olympiques-vue-93-4ep-am7z-saintdenis_silt.geojson",
    "geojson/20240726-20240726_parisien_cer-jj_silt.geojson",
    "geojson/20240726-20240726_pdf_cer1-jj-4ep-Wye8_silt.geojson",
    "geojson/20240824-20240811_presentation_sites-olympiques-vues-paris-4ep-01-QT2t_silt.geojson",
    "geojson/20240824-20240811_presentation_sites-olympiques-vues-paris-4ep-02-0l7u_silt.geojson",
    "geojson/20240824-20240811_presentation_sites-olympiques-vues-paris-4ep-03-gfyW_silt.geojson",
    "geojson/20240824-20240811_presentation_sites-olympiques-vues-paris-4ep-04-jYaC_silt.geojson",
    "geojson/20240824-20240811_presentation_sites-olympiques-vues-paris-4ep-05-royF_silt.geojson",
    "geojson/20240828-20240908_presentation_sites-olympiques-vue-93-4ep-am7z-circuit_silt.geojson",
    "geojson/20240828-20240908_presentation_sites-olympiques-vue-93-4ep-am7z-saintdenis_silt.geojson",
    "geojson/20240828-20240908_presentation_sites-olympiques-vues-paris-4ep-01-QT2t_silt.geojson",
    "geojson/20240828-20240908_presentation_sites-olympiques-vues-paris-4ep-02-0l7u_silt.geojson",
    "geojson/20240828-20240908_presentation_sites-olympiques-vues-paris-4ep-03-gfyW_silt.geojson",
    "geojson/20240828-20240908_presentation_sites-olympiques-vues-paris-4ep-04-jYaC_silt.geojson",
    "geojson/20240828-20240908_presentation_sites-olympiques-vues-paris-4ep-05-royF_silt.geojson",
];

geojsonPaths_arrondissements = [
    "geojson/arrondissements.geojson",
]

    function addGeoJSONToMap(geojson, layerName, color, opacity) {
      var layer = L.geoJSON(geojson, {
        style: function (feature) {
          return {
              'color': color,
              'opacity': 1,
              'fillOpacity': opacity
          };
        }
      }).addTo(map);
      geojsonLayers[layerName] = layer;
    }

    function loadGeoJSONFiles(geojsons, color, opacity) {
      geojsons.forEach(function (path) {
        fetch(path)
          .then(response => response.json())
          .then(data => {
            var layerName = path.substring(path.lastIndexOf('/') + 1, path.lastIndexOf('.'));
            addGeoJSONToMap(data, layerName, color, opacity);
          });
      });
    }

    loadGeoJSONFiles(geojsonPaths_bleu, 'orange', 1);
    loadGeoJSONFiles(geojsonPaths_rouge, 'red', 1);
    loadGeoJSONFiles(geojsonPaths_silt, 'black', 1);
    loadGeoJSONFiles(geojsonPaths_arrondissements, 'gray', 0);

    function searchAddresses() {
        const query = input.value;
        fetch(`https://api-adresse.data.gouv.fr/search/?lat=48.8566&lon=2.3522&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const addresses = data.features.map(feature => feature);
                displayAddressesSuggestions(addresses);
            })
            .catch(error => {
                console.error('Erreur lors de la recherche d\'adresses :', error);
            });
    }

    function displayAddressesSuggestions(addresses) {
        const suggestionsList = document.getElementById('suggestionsList');
        suggestionsList.innerHTML = '';
        addresses.forEach(feature => {
            const listItem = document.createElement('option');
            listItem.value = feature.properties.label;
            listItem.textContent = feature.properties.label;
            listItem.setAttribute('data-lng', feature.geometry.coordinates[0]);
            listItem.setAttribute('data-lat', feature.geometry.coordinates[1]);
            suggestionsList.appendChild(listItem);
        });
    }

    const input = document.getElementById('adresseInput');
    input.addEventListener('input', function(event) {
        searchAddresses();
    });


    function findLayersContainingPoint(point, pseudo_rayon = 1, exclude = []) {
      var layersContainingPoint = [];
      for (var layerName in geojsonLayers) {
        if (geojsonLayers.hasOwnProperty(layerName)) {
          var layer = geojsonLayers[layerName];
          layer.eachLayer(function (feature) {
            const carre = turf.polygon([[
                                    [point.lng - pseudo_rayon / 222000, point.lat - pseudo_rayon / 222000],
                                    [point.lng + pseudo_rayon / 222000, point.lat - pseudo_rayon / 222000],
                                    [point.lng + pseudo_rayon / 222000, point.lat + pseudo_rayon / 222000],
                                    [point.lng - pseudo_rayon / 222000, point.lat + pseudo_rayon / 222000],
                                    [point.lng - pseudo_rayon / 222000, point.lat - pseudo_rayon / 222000]
                                ]]);
            const inters = turf.intersect(feature.toGeoJSON().geometry, carre);
            if (inters && layersContainingPoint.indexOf(layerName) == -1 && exclude.indexOf(layerName) == -1) {
              layersContainingPoint.push(layerName);
            }
          });
        }
      }
      return layersContainingPoint;
    }

    document.getElementById('addressForm').addEventListener('submit', function (event) {
        searchAddresses();
        event.preventDefault();
        var address = document.getElementById('suggestionsList').children[0];
        var point = L.latLng( address.dataset.lat, address.dataset.lng);
        var layersContainingPoint = { "inside": [], "near": []}
        layersContainingPoint["inside"] = findLayersContainingPoint(point);
        layersContainingPoint["near"] = findLayersContainingPoint(point, 100, layersContainingPoint['inside']);

        var actifs = {
            "rouge": {'inside': {}, 'near': {}},
            "silt": {'inside': {}, 'near': {}},
            "bleu": {'inside': {}, 'near': {}}
        };
        var vus = {};

        console.log(actifs);
        ['inside', 'near'].forEach(function(proximity) {
            layersContainingPoint[proximity].forEach(function (layer){
                infos = layer.split('_');
                if (!infos[1]) {
                    return;
                }
                console.log(infos);
                if (!actifs[infos[3]][proximity][infos[0]]) {
                    actifs[infos[3]][proximity][infos[0]] = [];
                }
                actifs[infos[3]][proximity][infos[0]].push(layer);
            });
        });
        console.log(actifs);

        var titreDiv = document.getElementById('titre');
        titreDiv.innerHTML = 'Vue du ' + address.innerHTML;

        ['silt', 'rouge', 'bleu'].forEach(function(zone) {
            comment = {"inside": "", "near": ""};
            ['inside', 'near'].forEach(function(proximity) {
                if (Object.keys(actifs[zone][proximity]).length) {
                    nb = 0;
                    Object.keys(actifs[zone][proximity]).forEach((item) => {
                        sources = actifs[zone][proximity][item];
                        if (nb) {
                            comment[proximity] += " et";
                        }
                        dates = item.split('-');
                        if (dates[0] == dates[1]) {
                            comment[proximity] += " le "+dates[0].replace(/(....)(..)(..)/, '$3/$2/$1');
                        }else{
                            comment[proximity] += " du "+dates[0].replace(/(....)(..)(..)/, '$3/$2/$1')+" au "+dates[1].replace(/(....)(..)(..)/, '$3/$2/$1');
                        }
                        nb++;
                    });
                }
            })
            opacity = "0.5";
            html_comment = "";
            if(comment['inside'] || comment['near']) {
                html_comment = "<strong>";
                if(comment['inside']) {
                    html_comment += "<span style='color:red'>Vous êtes concerné⋅e par cette zone "+comment['inside']+".</span> ";
                }
                if(comment['near']) {
                    html_comment += comment["near"].charAt(1).toUpperCase() + comment["near"].slice(2);
                    html_comment += ", l'adresse indiquée ce situant à moins de 100 mètres d'une de ces zones, il est possible que vous soyez";
                    if(comment['inside']) {
                        html_comment += " également";
                    }
                    html_comment += " concerné⋅e.";
                }
                opacity = '1';
                html_comment += "</strong>";
            }else{
                html_comment = "Vous n'êtes pas concerné⋅e par cette zone";
            }
            document.getElementById('zone_'+zone+'_comment').innerHTML = html_comment;
            document.getElementById('zone_'+zone).style = "opacity:"+opacity;
        });

        L.marker(point).addTo(map);
        map.setView(point, 13);
    });
  </script>
</main>
</body>
</html>
